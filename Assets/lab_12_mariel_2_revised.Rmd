---
title: "Lab_12_Mariel_2: Sample Sizes and Labor Market Effects of the Mariel Boatlift"
output: html_notebook
---

## Introduction

In last week's lab we looked at specific sub-groups by education and racial-ethnic group to see if any were hurt economically by the sudden arrival of the Mariel Cubans. This week we are following up by calculating the statistical uncertainty in our results. We will do this by a technique called the "bootstrap", randomly resampling the data we have to tell us how much our results would vary had we drawn a different sample. The approach is called the "bootstrap" from the phrase "pull oneself up by one's bootstraps," using one's own resources to do the apparently impossible. In our case, we have a sample (the Current Population Survey) of about 120,000 people drawn from the actual population of Miami and other cities. Since we can't do the CPS over and over again, we can simulate drawing a new sample by re-drawing from our existing sample.

We've seen the idea of resampling before, when we looked at commodity prices and the bet. We asked if Simon had just gotten lucky. In that case, we resampled from the historical time series. Here we are doing something similar but resampling from our original survey sample itself. The motivation -- to see if what we are getting from our data is "luck" or "meaning" -- is similar, even though our approach is somewhat different.

## Confidence Intervals

For those of you who have already had a statistics class, the intervals from the resampling distribution that is part of the bootstrap are equivalent to the confidence intervals you have already studied. That is, their interpretation is that across repeated random samples, the confidence interval would cover the true population value the specified proportion of the time. The only new feature is that we are estimating the variation across different samples by simulation -- resampling the sample itself instead of the entire population.

For those of you who have not had statistics, we're going to think about the intervals generated by the bootstrap as covering a plausible range of values. That is we should be willing to consider all of the values in our interval as reasonable possibilities. 

For example, if our estimate from the sample is that unemployment in Miami increased by 2% more than in the comparison cities, with a confidence interval from -1% to 5%, then we could conclude that we don't have strong evidence that unemployment went up, because 0% change or even a -1% change is also plausible.

## A Mariel Example for 23 year-olds

Let's say that we only looked at the change in the unemployment rate of a small group --  for example,  23 year-olds from 1979 to 1982 in the CPS data that we used last time. In this case, we would have very small samples, and would not be very sure of the effect. Let's see how we can quantify this uncertainty.


```{r}
tot = 0
source("/data175/check_mariel_2.R")
source("http://courses.demog.berkeley.edu/goldstein175/Basket/check_functions.R")
```

We read in the CPS data just as we did in last week's lab:
```{r}
df <- read.csv("/data175/mariel_clean.csv")
esr <- df$esr # employment status
ftpt79 <- df$ftpt79 # full-time / part-time
ethrace <- df$ethrace ## combination of race an ethnicity
educ <- df$educ
year <- df$.id+1978 # years 1979, 1980, ..., 1985 for each record
weight <- df$weight # we are going to not use the weights (for simplicity)
earnwt <- df$earnwt # this is the weight one would use if you were using weights (we're not)
earnhr <- df$earnhr  
earnhre<-df$earnhre # this is the wage variable we use
age <- df$age
smsarank <- df$smsarank # names of "standard metropolitan statistical areas" (e.g. Miami)
## some vectors for the categories we're interested in 
ethrace.vec <- c("whites","blacks","cubans","hispanics") # good for ordering output
year.vec <- 1979:1985 # good for plotting
```

Now let's calculate the unemployment rate of 23 year-olds in 1979 and 1982.
```{r}
get.ue <- function(esr)
{
    sum(esr == "Unemployed-Looking") /
        sum(esr %in% c("Unemployed-Looking",
                       "Employed-At Work",
                       "Employed-Absent"))
}

## indices for 23 year olds in Miami in 1979 and 1982
s.79 <- age == 23 & smsarank == "Miami" & year == 1979
s.82 <- age == 23 & smsarank == "Miami" & year == 1982

## let's look at employment status
print("Unemployment of 23 year olds in Miami in 1979")
get.ue(esr[s.79])
print("Unemployment of 23 year olds in Miami in 1982")
get.ue(esr[s.82])

```

Q1.1 The difference between 11.1% and 5.7% is ...

A. The change in unemployment rate between 1979 and 1982 for all 23 year-olds in Miami.

B. The change in unemployment rate between 1979 and 1982 for all 23 year-olds sampled in the Current Population Survey. 

C. The change in unemployment rate between 1979 and 1982 for all 23 year-olds according to IRS records.


```{r}
## Replace the NA with your answer (e.g., 'A' in quotes)
answer1.1 = NA
check(answer1.1)
```

So it looks like the unemployment rate went up by about 5 percent.  But our sample sizes are probably quite small, less than 50 23-year-olds in each year:

```{r}
sum(s.79) ## CPS sample size for 23 year-olds in Miami in 1979
sum(s.82) ## same for 1982
```

See if you can find the unemployed people in the 1979 sample:
```{r}
print(esr[s.79])
```
Q1.2 How many unemployed 23 year olds are there in Miami in 1979 in the Current Population Survey (CPS)?

A. 1
B. 2
C. 3
D. 4

```{r}
## Replace the NA with your answer (e.g., 'A' in quotes)
answer1.2 = NA
check(answer1.2)
```

Now let's see how much faith we should put in observed increase of 5% seen in the CPS for this group. We can now ask ourselves what range of unemployment rate differences we believe is consistent with the data.

We use the "sample()" function in R, with replacement.

To see how the sample() function works, try the following:
```{r}
my.vec <- c("a", "p", "r", "i", "l")
sample(my.vec, size = 5, replace = T) # first random sample with replacement
sample(my.vec, size = 5, replace = T) # another random sample
sample(my.vec, replace = T) ## if you leave out "size", default is length of vector that one is sampling from.
```
Note that sampling with replacement allows the possibility of drawing the same element more than once.

Q1.3 Did the same letter appear more than once?

A. Yes
B. No
```{r}
## Replace the NA with your answer (e.g., 'A' in quotes)
answer1.3 = NA
check(answer1.3)
```


Now let's draw 1,000 resamples from our CPS data and see how the estimate of unemployment varies from one resample to the next. 
```{r}
n.redraws <- 1000 # number of times we redraw a new "resample" of our original sample
ue.increase.vec <- rep(NA, length = n.redraws) # to store the observed increase in unemployment for each resample
for (i in 1:n.redraws)
{
  ## The approach we take here is to resample from our    previously specified sub-samples (e.g., s.79, the 23 year olds in Miami in 1979).
  resampled.esr.79 <- sample(esr[s.79], replace = TRUE)
  resampled.esr.82 <- sample(esr[s.82], replace = TRUE)
  resampled.ue.79 <- get.ue(resampled.esr.79)
  resampled.ue.82 <- get.ue(resampled.esr.82)
  ue.increase.vec[i] <- resampled.ue.82 - resampled.ue.79
}
head(ue.increase.vec) ## look at the first few values
```
We see there's quite a bit of variation, and so a wide range of changes in unemployment appear plausible. 

Q1.4 These values of increased unemployment are for 

A. Different samples from the complete Miami population of 23 year olds.
B. Simulated re-samples from the sample of Miami 23 year olds that were in the CPS

```{r}
## Replace the NA with your answer (e.g., 'A' in quotes)
answer1.4 = NA
check(answer1.4)
```

To quantify further, we can produce, say, an 80% interval for these estimates.

```{r}
ue.increase.interval <- quantile(ue.increase.vec, probs = c(.1, .9))
## the quantile() functions tells us the values below which a specified fraction of the data are found. So quantile(x, probs = .1) tells us the 10th percentile of the data, the value that 10% of the data is less than. With the argument "prbs = c(.1, .9), the quantile function gives us an 80% range between the 10th and 90th percentiles.
print(ue.increase.interval)
```
We can visualize this in terms of the increase in unemployment seen across the many resamples.

```{r}
hist(ue.increase.vec) # a histogram 
abline(v = ue.increase.interval, col = "red") # the 80% interval
```

So, although we saw a 5% increase in the original CPS sample of 23-year-olds, the bootstrap resampling indicates that a wide-range of changes in unemployment are all consistent with the data. In this case, our uncertainty ranges from -3% to +14%. Importantly, our interval includes 0, and so it is quite possible that we would see no increase at all if we had a complete count of Miami rather than a sample.

## The uncertainty of Card's difference-in-difference estimator

In our analysis of the effect of the Mariel boatlift, we are looking at whether the changes in labor market indicators in Miami before and after the boatlift differed from the changes in cities that didn't get an influx of Cubans. This is an example of a difference-in-difference estimator. We can use the bootstrap to say more about how much we can conclude from this more complicated statistic.

We begin with the example of Hispanics with less than a high-school education, comparing 1979 and 1982 in Miami and the comparison cities. We can re-use the code from the last lab to produce tables of unemployment for every year and every racial/ethnic group.

```{r}
s <- age %in% 16:61 & smsarank == "Miami"
ue.educ.ethrace.table.miami <- tapply(X = esr[s],
                         FUN = get.ue,
                         INDEX = list(educ[s], year[s], ethrace[s]))

s <- age %in% 16:61 & smsarank != "Miami"
ue.educ.ethrace.table.notmiami <- tapply(X = esr[s],
                         FUN = get.ue,
                         INDEX = list(educ[s], year[s], ethrace[s]))
print("miami")
print(ue.educ.ethrace.table.miami)
print("not miami")
print(ue.educ.ethrace.table.notmiami)
```

This is too much information! Let's focus on the difference-in-difference estimator for the group that we are interested in now: Hispanics with "lessHS" education from 1979 to 1981. 


```{r}
my.ue.miami <- ue.educ.ethrace.table.miami["lessHS", 
                                           c("1979", "1982"), 
                                           "hispanics"] ## note: we have 3 dimensions to this table and so we need two commas
my.ue.notmiami <- 
  ue.educ.ethrace.table.notmiami["lessHS",
                                 c("1979", "1982"),
                                 "hispanics"]
print("miami, hispanics, lessHS")
print(my.ue.miami)
print("not miami, hispanics, lessHS")
print(my.ue.notmiami)

dd.est <- diff(my.ue.miami) - diff(my.ue.notmiami)
print("difference-in-difference estimate")
print(dd.est)
```
Here a positive number would mean that unemployment went up more in Miami than in the comparison cities. A negative number means that unemployment actually went up less in Miami. Does this mean that the Mariel influx looks like it "caused" unemployment to go _down_ by about 6 percentage points? Well, yes if we believe that our sample really represents what happened in the population. But our sample sizes are small, and so we should check using the bootstrap.
  
```{r}  
s.miami.elements <- which(age %in% 16:61 & smsarank == "Miami")
s.notmiami.elements <- which(age %in% 16:61 & smsarank != "Miami")
## the which() function returns the element number, which is easy to resample. before we resampled the whole vector of values. Now we just sample the index numbers. 


n.redraws <- 400 ## we do fewer because 1000 takes a while
dd.est.vec <- rep(NA, length = n.redraws)
for (i in 1:n.redraws) ## this takes a few minutes to do so many times
{
  s.miami.redraw <- sample(s.miami.elements, replace = TRUE)
  s.notmiami.redraw <- sample(s.notmiami.elements, replace = TRUE)
  s <- s.miami.redraw ## use the resampled index
  ue.educ.ethrace.table.miami <- tapply(X = esr[s],
                         FUN = get.ue,
                         INDEX = list(educ[s], year[s], ethrace[s]))
  s <- s.notmiami.redraw # use the resampled index
  ue.educ.ethrace.table.notmiami <- tapply(X = esr[s],
                           FUN = get.ue,
                           INDEX = list(educ[s], year[s], ethrace[s]))

my.ue.miami <- ue.educ.ethrace.table.miami["lessHS", c("1979", "1982"), "hispanics"]
my.ue.notmiami <- ue.educ.ethrace.table.notmiami["lessHS", c("1979", "1982"), "hispanics"]

dd.est <- diff(my.ue.miami) - diff(my.ue.notmiami)
dd.est.vec[i] <- dd.est
}
```

```{r}
my.interval <- quantile(dd.est.vec, c(.1, .9))
print(my.interval)
```
```{r}
hist(dd.est.vec)
abline(v = my.interval, col = "red")
```
Although much of the interval is negative, the value 0 and some positive values are also within the bootstrap 80% interval, making them plausible values for the population given the information in the CPS. So, we would be reluctant to conclude with much certainty that the Mariel boatlift actually made employment go down for less educated Hispanics. 

Of course, the argument for those worried about immigration's effect on natives is that unemployment would rise. Here the evidence is even weaker. It is _possible_ that unemployment could have gone up for this group, but the most common answer we got from our resampling was that it went down. A cautious analyst would say that the evidence is not strong enough to conclude with much certainty that there was any clear non-zero effect.


## Graded exercises

1. Repeat the above estimate of the difference-in-difference estimate of the effect of the boatlift on _Black_ unemployment with "lessHS" education from 1979 to 1982. What does the CPS sample tell us? (Hint: the label for the African-American population is "blacks") [ < 25 words]

2. Now resample the CPS sample. What is the 80 percent interval of your resampling distribution?

3. What would you conclude about the effect of the boatlift on the unemployment rate of Blacks with less than a high school education?
[ < 50 words]

4. If the CPS had no unemployed people in a specific group, then would the resampling approach help you to say how certain or uncertain you were?  Explain briefly [ < 25 words].

5. Could we apply the resampling approach to our earlier problem of looking at the recovery of fertility after the Great Recession for college-graduates vs. non-college graduates? [1 word is fine]


Congratulations! You've finished lab 12.

